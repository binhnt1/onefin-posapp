package com.onefin.posapp.core.utils

import android.content.Context
import android.text.TextUtils
import com.atg.pos.domain.entities.payment.TLVUtil
import com.onefin.posapp.core.models.EvmConfig
import com.onefin.posapp.core.models.Terminal
import com.onefin.posapp.core.models.data.CvmConfig
import com.onefin.posapp.core.models.data.RequestSale.Data.Card
import com.sunmi.pay.hardware.aidl.AidlConstants
import com.sunmi.pay.hardware.aidlv2.bean.AidV2
import com.sunmi.pay.hardware.aidlv2.bean.CapkV2
import com.sunmi.pay.hardware.aidlv2.bean.EmvTermParamV2
import com.sunmi.pay.hardware.aidlv2.emv.EMVOptV2
import com.sunmi.pay.hardware.aidlv2.security.SecurityOptV2
import java.util.Locale
import kotlin.text.ifEmpty
import kotlin.text.toInt


object EmvUtil {

    fun injectAids(context: Context, emvOptV2: EMVOptV2) {
        try {
            // clear SDK built-in AIDs and CAPKs
            emvOptV2.deleteAid(null)

            // Náº¡p AID máº·c Ä‘á»‹nh
            val aidList = listOf(
                "9F0607A0000000041010DF0101009F09020002DF1105FE50BCA000DF1205FE50BCF800DF130500000000009F1B00DF150400000000DF160100DF170100DF14039F3704DF18009F7B06000000000000DF1906000000000000DF2006999999999999DF21060001000000009F01060000000000009F4E818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009F150200009F1610000000000000000000000000000000009F3C0207049F3D0100DFC1080100DFC10901009F1C0800000000000000009F1D080000000000000000DF81010400000000DF810200DFC10A0102DFC10B01009F660400000000DFC10C0102DFC10D0100",
                "9F0607A0000000031010DF0101009F09020002DF1105DC4000A800DF1205DC4004F800DF130500100000009F1B00DF150400000000DF160100DF170100DF1400DF18009F7B06000000000000DF1906000000000000DF2006999999999999DF21060001000000009F01060000000000009F4E818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009F150200009F1610000000000000000000000000000000009F3C0207049F3D0100DFC1080100DFC10901009F1C0800000000000000009F1D080000000000000000DF81010400000000DF810200DFC10A0103DFC10B01009F660432004000DFC10C0103DFC10D0100",
                "9F0607A0000000032010DF0101009F09020002DF1105DC4000A800DF1205DC4000F800DF130500100000009F1B00DF150400000000DF160100DF170100DF1400DF18009F7B06000000000000DF1906000000000000DF2006999999999999DF21060001000000009F01060000000000009F4E818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009F150200009F1610000000000000000000000000000000009F3C0207049F3D0100DFC1080100DFC10901009F1C0800000000000000009F1D080000000000000000DF81010400000000DF810200DFC10A0103DFC10B01009F660432004000DFC10C0103DFC10D0100",
                "9F0607A0000000033010DF0101009F09020002DF1105DC4000A800DF1205DC4000F800DF130500100000009F1B00DF150400000000DF160100DF170100DF1400DF18009F7B06000000000000DF1906000000000000DF2006999999999999DF21060001000000009F01060000000000009F4E818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009F150200009F1610000000000000000000000000000000009F3C0207049F3D0100DFC1080100DFC10901009F1C0800000000000000009F1D080000000000000000DF81010400000000DF810200DFC10A0103DFC10B01009F660432004000DFC10C0103DFC10D0100",
                "9F0607A0000007271010DF0101009F09020001DF1105BCF8049800DF1205BCF8049800DF130500000000009F1B00DF150400000000DF160100DF170100DF14039F3704DF18009F7B06000000000000DF1906000000000000DF2006999999999999DF21060001000000009F01060000000000009F4E818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009F150200009F1610000000000000000000000000000000009F3C0207049F3D0100DFC1080100DFC10901009F1C0800000000000000009F1D080000000000000000DF81010400000000DF810200DFC10A0109DFC10B01009F660400000000DFC10C0100DFC10D0100",
                "9F0607A0000000651010DF0101009F09020200DF1105FC6024A800DF1205FC60ACF800DF130500100000009F1B00DF150400000000DF160100DF170100DF14039F3704DF18009F7B06000000000000DF1906000000000000DF2006999999999999DF21060001000000009F01060000000000009F4E818000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009F150200009F1610000000000000000000000000000000009F3C0207049F3D0100DFC1080100DFC10901009F1C0800000000000000009F1D080000000000000000DF81010400000000DF810200DFC10A0106DFC10B01009F660400000000DFC10C0105DFC10D0100"
            )
            for ((_, aidHexString) in aidList.withIndex()) {
                try {
                    val aidToAdd = hexStr2Aid(aidHexString) // Parse hex string thÃ nh AidV2
                    emvOptV2.addAid(aidToAdd)
                } catch (e: Exception) {
                    Timber.e(e, "   Lá»—i khi parse/náº¡p AID: ${aidHexString.take(50)}...")
                }
            }
            Timber.d("   âœ… Náº¡p AIDs máº·c Ä‘á»‹nh tá»« tÃ i liá»‡u thÃ nh cÃ´ng!")
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
    fun injectCapks(context: Context, emvOptV2: EMVOptV2) {
        try {
            // clear SDK built-in AIDs and CAPKs
            emvOptV2.deleteCapk(null, null)

            // Náº¡p CAPK máº·c Ä‘á»‹nh
            val capkList = listOf(
                "9F0605A0000007279F220101DF0503135019DF060100DF070100DF0281F88B4DD21AB688BE8B0B369E7D7D9F747D6A2148E1CA2D27B8372F6089F49C678B4DF6E8A12EE6793BBAA5508984230296C3BBB9BA3370F98B1C646F95B00D095B01AE895562EDB308CC3629C73E55AB2E49CC8DEF8A0D5D0317767BADD6C55DF8AA27317FF9E5BF11DB107491D6CD805394F12879424DA475EE5A7F82750FF6AC6FE314B4C0E622E0F017AD6A094A0F323FD1D94F42B75A565478F4971C0632DAF5D557433E28F0393B2A19B6DB8938530C69BD765E9734AAB220A115DA49395C8BD6C16F87421FBCAB8BC5AF765C85040E40674B649E61D3506AFEB2BAF9C9723BB66A34BC0E44726B1755D3D4935B451A0C4A87CDDEBD51DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000007279F220195DF0503135019DF060100DF070100DF0281B0C4BC12801C975A0F13F81290D953313BB0ACB341458E8A07C77DDE0DA558C27886FE29C289C6E3480F6C6B39563F1E63E17C2E80C7A4C16CC9E9BDBC5A9BB5806EE983059643C5351A990A6938F616D828E7CB865016B16CF6809087D568C7874DBA67785600B64F1E148187DC75BC3FD30FDA63C5FC9E91C6958CE2986CD0FA3354D62AE00E5CDD144C220A228DA7C948918DEE92AD3DB69326600865A4229963E3FB94D9E79AC4350AC9ED44274EBDDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000007279F220199DF0503135019DF060100DF070100DF0281F8B5A2D7130183614F9461E7D120D5FE7EEE627524EB972FDA552484B9FC11AA96F36FB0080F28AB375209E33C4215B897766BD3EF16CDF03AA9496AEBF5E1FEF61446BE47E30B671880B04E66487EBC74E84B87F0FC026257A97E069DB54666368D9D8355BF37545ED8620C44BA6C7CADB7262A8C6A34394ABAAF60C43684669B7862221967CFF8B5C384C9E71B6D02FB5BC315CC36BEE673A3596F20CC7E49CE3899AC42577515B847E425BCF691CF8164141B2ADC06F0CDF9DFB1483728A8BD2F033FF442957E5D97BE731CC2B8C64B5AD3804BE3D5BE47BC3C355908DB8F4D0FA2ACFFE9E703777CB5D45F92AB87D9D9ED1A27FD2E00DBDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000006029F220105DF0503135019DF060100DF070100DF0281B0B48CC63D71A486DFC920608A3E42D7C305472BF76B8E50C8C02FB8387E788F72931A29DC15F913E7D69E43AD4C38A5C4317E36D15DE5F49FA2327D9754799D2484A6E156941ACA9632417E5C92931A85E1BB5F2A2C1B847D5008C7B30591F1ACBF3B98DFB0CF2849B6C7CDC7435AEA85F3A58BAC3B8C990416A5E19EC4EA08DC91CEF2FBE5940FA6622926D2AD0523D109A7024EB1035BBE37260B30F41AA52EEB36E60DD37120B9401C3850920F0E03DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000006029F2201F5DF0503135019DF060100DF070100DF0281B09F2E972FF3F00759772AF850CBCD0B8BE411FE2D104CEB1B218E91F9F008DCC30DE61F42224C6A6BE07DAC048DA16CF24C43E600CEC4BBD4C5674494788F703AA4469E7DBC3B9923C2C54B50D4971D176A0E62F6875611B9CE5E247D24AC26926F22D0705D39A65808790232702E8C1A80291CA2C8AD890925B0EA20069761DF863B374FFB41A53ECB229867FBC6475C054B407C41E170265F08634E61324228A32466EF26E6BD5A2C150740A2F5D7B5DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000006589F2201D1DF05031343F0DF060100DF070100DF0281F0A3547415A7D237C09FC8AFF989FDA49E5B3275545026361C1A8DE477467F963D8F6F58A2F16E0885E4759CA58F72A5B5446CE3893155EFD978B2F0D8D1A7294AC7870D65B5CC78286F96237EFCBA02C6844A84DB79A01D225FF3BEAB3761AFC52AEDD57764483C980076D10E4C3485011DD93A970C57FC72A1CCA47C7D1B57E5D7798A180BF08455A4D602CFC3C881034B52D6DF2C3B1A8FEE7E6539EA35F6B5C123A822AA73FB6BDFD894AEB8381A62413EFB030F85DC45D71B66A322F1532A91C9AD8E4820AC18C544A623FC3E401D42498C1C9B88E5A6B7DA2D9E0BF7CB3F921242B5352302B95EE1344D79ECE49DDF04021000DF03140000000000000000000000000000000000000000",
                "9F0605A0000006589F2201D2DF05031343F0DF060100DF070100DF0281C887DF1B2E39252EA14AA937D0EF2B35DC5C15E5A8DEEC1510BA0A2759500E86685FB765B102F440BEC872503ED7919AF72DEBA2F50B7CC6A4C4BC0548AF201C7274FAF248239D67FC72A123690300C9A064A5AB97B7F26CFA378A7A0BA3D551B74EA953496858A81EF6A44AA659C253551DD45174BB2A248FDBB66D614BA1C018F952A45C73E1149FEADC5B3E2561BEF8D4EE0150807EA1DDE9B3DDECD5428E3E79721ADDC660DD28B9CC3BF06066176405D822D659AC7BB9354AA3BA33DDEAD47DD34B4264E34581DF04021000DF03140000000000000000000000000000000000000000",
                "9F0605A0000006589F2201D3DF05031321B6DF060100DF070100DF0281909AF692FFA01A2CC61B97820AAFCBF0844B859726DE13AD4CAA8D3389A13728B588E1DD33373C8624D9D4BE468FA72F5EEEBB5FC904A386ACEF2A4D8A6F8AEFD69164CD56183C381BD7FCC2A16C6B12305729FFEA766699F54CA01D97761170C7A77B027028F12FB79FCB5E034983743A5CE9C2FE0753021BC9C8CA7555320D0CF4E1182F96BC3A1500C335199E701459DF04021000DF03140000000000000000000000000000000000000000",
                "9F0605A0000000039F220198DF05031321B6DF060100DF070100DF0270CA026E52A695E72BD30AF928196EEDC9FAF4A619F2492E3FB31169789C276FFBB7D43116647BA9E0D106A3542E3965292CF77823DD34CA8EEC7DE367E08070895077C7EFAD939924CB187067DBF92CB1E785917BD38BACE0C194CA12DF0CE5B7A50275AC61BE7C3B436887CA98C9FD39DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000039F220195DF05031337AFDF060100DF070100DF028190BE9E1FA5E9A803852999C4AB432DB28600DCD9DAB76DFAAA47355A0FE37B1508AC6BF38860D3C6C2E5B12A3CAAF2A7005A7241EBAA7771112C74CF9A0634652FBCA0E5980C54A64761EA101A114E0F0B5572ADD57D010B7C9C887E104CA4EE1272DA66D997B9A90B5A6D624AB6C57E73C8F919000EB5F684898EF8C3DBEFB330C62660BED88EA78E909AFF05F6DA627BDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000039F220192DF05031404CFDF060100DF070100DF0281B0996AF56F569187D09293C14810450ED8EE3357397B18A2458EFAA92DA3B6DF6514EC060195318FD43BE9B8F0CC669E3F844057CBDDF8BDA191BB64473BC8DC9A730DB8F6B4EDE3924186FFD9B8C7735789C23A36BA0B8AF65372EB57EA5D89E7D14E9C7B6B557460F10885DA16AC923F15AF3758F0F03EBD3C5C2C949CBA306DB44E6A2C076C5F67E281D7EF56785DC4D75945E491F01918800A9E2DC66F60080566CE0DAF8D17EAD46AD8E30A247C9FDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000039F220194DF0503133F02DF060100DF070100DF0281F8ACD2B12302EE644F3F835ABD1FC7A6F62CCE48FFEC622AA8EF062BEF6FB8BA8BC68BBF6AB5870EED579BC3973E121303D34841A796D6DCBC41DBF9E52C4609795C0CCF7EE86FA1D5CB041071ED2C51D2202F63F1156C58A92D38BC60BDF424E1776E2BC9648078A03B36FB554375FC53D57C73F5160EA59F3AFC5398EC7B67758D65C9BFF7828B6B82D4BE124A416AB7301914311EA462C19F771F31B3B57336000DFF732D3B83DE07052D730354D297BEC72871DCCF0E193F171ABA27EE464C6A97690943D59BDABB2A27EB71CEEBDAFA1176046478FD62FEC452D5CA393296530AA3F41927ADFE434A2DF2AE3054F8840657A26E0FC617DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F220101DF05031343F0DF060100DF070100DF028180BBE9066D2517511D239C7BFA77884144AE20C7372F515147E8CE6537C54C0A6A4D45F8CA4D290870CDA59F1344EF71D17D3F35D92F3F06778D0D511EC2A7DC4FFEADF4FB1253CE37A7B2B5A3741227BEF72524DA7A2B7B1CB426BEE27BC513B0CB11AB99BC1BC61DF5AC6CC4D831D0848788CD74F6D543AD37C5A2B4C5D5A93BDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F220102DF0503134661DF060100DF070100DF028190A3767ABD1B6AA69D7F3FBF28C092DE9ED1E658BA5F0909AF7A1CCD907373B7210FDEB16287BA8E78E1529F443976FD27F991EC67D95E5F4E96B127CAB2396A94D6E45CDA44CA4C4867570D6B07542F8D4BF9FF97975DB9891515E66F525D2B3CBEB6D662BFB6C3F338E93B02142BFC44173A3764C56AADD202075B26DC2F9F7D7AE74BD7D00FD05EE430032663D27A57DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F220103DF0503134DB4DF060100DF070100DF0281B0B0627DEE87864F9C18C13B9A1F025448BF13C58380C91F4CEBA9F9BCB214FF8414E9B59D6ABA10F941C7331768F47B2127907D857FA39AAF8CE02045DD01619D689EE731C551159BE7EB2D51A372FF56B556E5CB2FDE36E23073A44CA215D6C26CA68847B388E39520E0026E62294B557D6470440CA0AEFC9438C923AEC9B2098D6D3A1AF5E8B1DE36F4B53040109D89B77CAFAF70C26C601ABDF59EEC0FDC8A99089140CD2E817E335175B03B7AA33DDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F220104DF0503134DB4DF060100DF070100DF0281F8BC853E6B5365E89E7EE9317C94B02D0ABB0DBD91C05A224A2554AA29ED9FCB9D86EB9CCBB322A57811F86188AAC7351C72BD9EF196C5A01ACEF7A4EB0D2AD63D9E6AC2E7836547CB1595C68BCBAFD0F6728760F3A7CA7B97301B7E0220184EFC4F653008D93CE098C0D93B45201096D1ADFF4CF1F9FC02AF759DA27CD6DFD6D789B099F16F378B6100334E63F3D35F3251A5EC78693731F5233519CDB380F5AB8C0F02728E91D469ABD0EAE0D93B1CC66CE127B29C7D77441A49D09FCA5D6D9762FC74C31BB506C8BAE3C79AD6C2578775B95956B5370D1D0519E37906B384736233251E8F09AD79DFBE2C6ABFADAC8E4D8624318C27DAF1DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F220108DF0503135C5ADF060100DF070100DF028190B61645EDFD5498FB246444037A0FA18C0F101EBD8EFA54573CE6E6A7FBF63ED21D66340852B0211CF5EEF6A1CD989F66AF21A8EB19DBD8DBC3706D135363A0D683D046304F5A836BC1BC632821AFE7A2F75DA3C50AC74C545A754562204137169663CFCC0B06E67E2109EBA41BC67FF20CC8AC80D7B6EE1A95465B3B2657533EA56D92D539E5064360EA4850FED2D1BFDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F220109DF0503135C5ADF060100DF070100DF0281B0EB374DFC5A96B71D2863875EDA2EAFB96B1B439D3ECE0B1826A2672EEEFA7990286776F8BD989A15141A75C384DFC14FEF9243AAB32707659BE9E4797A247C2F0B6D99372F384AF62FE23BC54BCDC57A9ACD1D5585C303F201EF4E8B806AFB809DB1A3DB1CD112AC884F164A67B99C7D6E5A8A6DF1D3CAE6D7ED3D5BE725B2DE4ADE23FA679BF4EB15A93D8A6E29C7FFA1A70DE2E54F593D908A3BF9EBBD760BBFDC8DB8B54497E6C5BE0E4A4DAC29E5DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F22010ADF0503135C5ADF060100DF070100DF028180B2AB1B6E9AC55A75ADFD5BBC34490E53C4C3381F34E60E7FAC21CC2B26DD34462B64A6FAE2495ED1DD383B8138BEA100FF9B7A111817E7B9869A9742B19E5C9DAC56F8B8827F11B05A08ECCF9E8D5E85B0F7CFA644EFF3E9B796688F38E006DEB21E101C01028903A06023AC5AAB8635F8E307A53AC742BDCE6A283F585F48EFDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F22010BDF0503135C5ADF060100DF070100DF0281F8CF9FDF46B356378E9AF311B0F981B21A1F22F250FB11F55C958709E3C7241918293483289EAE688A094C02C344E2999F315A72841F489E24B1BA0056CFAB3B479D0E826452375DCDBB67E97EC2AA66F4601D774FEAEF775ACCC621BFEB65FB0053FC5F392AA5E1D4C41A4DE9FFDFDF1327C4BB874F1F63A599EE3902FE95E729FD78D4234DC7E6CF1ABABAA3F6DB29B7F05D1D901D2E76A606A8CBFFFFECBD918FA2D278BDB43B0434F5D45134BE1C2781D157D501FF43E5F1C470967CD57CE53B64D82974C8275937C5D8502A1252A8A5D6088A259B694F98648D9AF2CB0EFD9D943C69F896D49FA39702162ACB5AF29B90BADE005BC157DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000003339F22010CDF0503135C5ADF060100DF070100DF028190DED9E1BC8E749CAD749484BFB472445BC81FFAA89707648C342AA30D1BE60D5ED0F6CEABA25C683D4503CB11CAF91A39727593CF2BEEAE8032EFACC44FDF8DA31D6007139D4595E8655C7495CF46A9D593A83E3C65B2CBF2AF1EEA02D1F96951A946616B5AB21CA0BF34D12D05F6AE183508A7AC7A46913BDCE5FDC3914CA750018B130CA5BAD49AD8C02291ACA5CFFDDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000659F2201ECDF05031343F0DF060100DF070100DF0281F8A9EDFDC58029A7EC003D13F22F6AED5622786D45F7C36516A3DBFE4D75BFCE00F4CF656670CD07A66A99A7CD35D2F5228CB2D794B95C4930FDDAD17F8C9293164AFEC876D5644DD31ABFE86B7AA512C58D5C71310FB36E8D7CCFF4C958669C0042DFF048F52E412B530C3BB77555B6F9B35E2C0F1B17A6180D03D94914B4970A42309F259DB37EC77FF6BA04BACF6B17FF7B10C1A04272D08C043A1C8E8951681DE41BE30F4E42D3ED3FE3328BD4C6327B19D110A2E85D9DC4C34225A2F0CA7684FF5C05C1F01135FC51D7331E3A413AED0942C8BBDB975104E171B08EE7C2B388EC4EA493BE5FCB0C416DF2A9DBBCDFA5D12344EC30576BDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000049F2201EFDF05031404CFDF060100DF070100DF0281F8A191CB87473F29349B5D60A88B3EAEE0973AA6F1A082F358D849FDDFF9C091F899EDA9792CAF09EF28F5D22404B88A2293EEBBC1949C43BEA4D60CFD879A1539544E09E0F09F60F065B2BF2A13ECC705F3D468B9D33AE77AD9D3F19CA40F23DCF5EB7C04DC8F69EBA565B1EBCB4686CD274785530FF6F6E9EE43AA43FDB02CE00DAEC15C7B8FD6A9B394BABA419D3F6DC85E16569BE8E76989688EFEA2DF22FF7D35C043338DEAA982A02B866DE5328519EBBCD6F03CDD686673847F84DB651AB86C28CF1462562C577B853564A290C8556D818531268D25CC98A4CC6A0BDFFFDA2DCCA3A94C998559E307FDDF915006D9A987B07DDAEB3BDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000049F2201FADF05031404CFDF060100DF070100DF028190A90FCD55AA2D5D9963E35ED0F440177699832F49C6BAB15CDAE5794BE93F934D4462D5D12762E48C38BA83D8445DEAA74195A301A102B2F114EADA0D180EE5E7A5C73E0C4E11F67A43DDAB5D55683B1474CC0627F44B8D3088A492FFAADAD4F42422D0E7013536C3C49AD3D0FAE96459B0F6B1B6056538A3D6D44640F94467B108867DEC40FAAECD740C00E2B7A8852DDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000049F2201F1DF05031404CFDF060100DF070100DF0281B0A0DCF4BDE19C3546B4B6F0414D174DDE294AABBB828C5A834D73AAE27C99B0B053A90278007239B6459FF0BBCD7B4B9C6C50AC02CE91368DA1BD21AAEADBC65347337D89B68F5C99A09D05BE02DD1F8C5BA20E2F13FB2A27C41D3F85CAD5CF6668E75851EC66EDBF98851FD4E42C44C1D59F5984703B27D5B9F21B8FA0D93279FBBF69E090642909C9EA27F898959541AA6757F5F624104F6E1D3A9532F2A6E51515AEAD1B43B3D7835088A2FAFA7BE7DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000049F220105DF0503134DB4DF060100DF070100DF0281B0B8048ABC30C90D976336543E3FD7091C8FE4800DF820ED55E7E94813ED00555B573FECA3D84AF6131A651D66CFF4284FB13B635EDD0EE40176D8BF04B7FD1C7BACF9AC7327DFAA8AA72D10DB3B8E70B2DDD811CB4196525EA386ACC33C0D9D4575916469C4E4F53E8E1C912CC618CB22DDE7C3568E90022E6BBA770202E4522A2DD623D180E215BD1D1507FE3DC90CA310D27B3EFCCD8F83DE3052CAD1E48938C68D095AAC91B5F37E28BB49EC7ED597DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000259F2201C8DF05031404CFDF060100DF070100DF028190BF0CFCED708FB6B048E3014336EA24AA007D7967B8AA4E613D26D015C4FE7805D9DB131CED0D2A8ED504C3B5CCD48C33199E5A5BF644DA043B54DBF60276F05B1750FAB39098C7511D04BABC649482DDCF7CC42C8C435BAB8DD0EB1A620C31111D1AAAF9AF6571EEBD4CF5A08496D57E7ABDBB5180E0A42DA869AB95FB620EFF2641C3702AF3BE0B0C138EAEF202E21DDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000259F2201C9DF05031404CFDF060100DF070100DF0281B0B362DB5733C15B8797B8ECEE55CB1A371F760E0BEDD3715BB270424FD4EA26062C38C3F4AAA3732A83D36EA8E9602F6683EECC6BAFF63DD2D49014BDE4D6D603CD744206B05B4BAD0C64C63AB3976B5C8CAAF8539549F5921C0B700D5B0F83C4E7E946068BAAAB5463544DB18C63801118F2182EFCC8A1E85E53C2A7AE839A5C6A3CABE73762B70D170AB64AFC6CA482944902611FB0061E09A67ACB77E493D998A0CCF93D81A4F6C0DC6B7DF22E62DBDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000259F2201CADF05031404CFDF060100DF070100DF0281F8C23ECBD7119F479C2EE546C123A585D697A7D10B55C2D28BEF0D299C01DC65420A03FE5227ECDECB8025FBC86EEBC1935298C1753AB849936749719591758C315FA150400789BB14FADD6EAE2AD617DA38163199D1BAD5D3F8F6A7A20AEF420ADFE2404D30B219359C6A4952565CCCA6F11EC5BE564B49B0EA5BF5B3DC8C5C6401208D0029C3957A8C5922CBDE39D3A564C6DEBB6BD2AEF91FC27BB3D3892BEB9646DCE2E1EF8581EFFA712158AAEC541C0BBB4B3E279D7DA54E45A0ACC3570E712C9F7CDF985CFAFD382AE13A3B214A9E8E1E71AB1EA707895112ABC3A97D0FCB0AE2EE5C85492B6CFD54885CDD6337E895CC70FB3255E3DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220128DF05031343F0DF060100DF070100DF0281B0C05B993401063615EF211036DD8154066BE4BBEC7E93A82E83C65E2CFD76E498A6DBF6135C816F606B9564A30D259A9FD5463AA78261223FBB4718EAD4A17347E11BE475BF0DDD9BE9315DCF585D58863A7BCA0E67440586DA098E33047C0DF6F6A1D1BD081BF283321DDF248FDFFA9FB749D0FDA47ADE2E7C0AAA76B146A00A5EBDA270C52832E8132FBC631EAC1120F02215829EB1D852B1969F1C1504A659AB6057C92AF92D981C8171B68E3300E3DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220120DF0503134DB4DF060100DF070100DF0281C0EBA2E3FBE75D51C519B7A498CFE53F51519B292C1BBE0C78C14FBE38E3717DE0C0ECC04605879EF617B97ED1E8E989FCD2C7DDF61EE09E96F7EADA7D9F553426D6D6A8BE4DCF943D6C8F3627265520F757BBA16FF68749F3D796A0AAACA0ED0929BE112BF7CAB87BED4D9B5DD9B7A0CAC7F9CA513A6BFC03B4C20EFDC03E2B58D76E2ABF466665CB9D64AA412FBBF85259C480DA2F0896AB28FBB26022EFAE74CCDB9C36749E8D29AE4069A1298A0B07A7F72DFF8E6F442A2393DFF7E4E1F06FDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220122DF0503134DB4DF060100DF070100DF0281C09CC38384539AFFDB955ADF9FCF03A6A669B5F68D91DBE1562002D4617E75FF0BEF16731D8CAE5B6E690E00C0F106BD8EB127DAD03108D40576C95572B3C43E4A9641C11C4C5AED06643543CD02B6E3811FBC4F72956CA9D8641374CFB659263B8B22B5C5A3B624E99BF5CBFD34B99A069DA312B1F7C03CF8F4CFA91BB269DBD565073A9AFCB1DA7D839F13D43B57F924BB85E1BCCE28BE5A8EC03AA56FED231B13B920A3BA4227F53F927EC27F9DB20C32EB2AD8F9C0770EC97D930764E844C9DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220129DF0503134DB4DF060100DF070100DF0281F8B6D73BF68564C88A1AEE8BA70A5F60CE495CA722E097DADEEBB83B28040B1BAD16DBC9AC3CD181BA89193638E600AF397D220F0339A8E792AA08C1878482ACC463B3B3A257AE8667CDBC1D6613CB9CBB612830FDA7F7BA689A148EFFF34476F6E0A70C819C10B3B6150909B58BF9403F5BB2E9790EE82C50C8D6FB267C726DC255AE97FABF5A357B2A0FBD1387168D83B25ECD912027B3868F072E025240CF780CC8E5839823727E5547FD1366A203F4F70FA82660B8401D4D2D06FD9A4036D14C53F6289D6FDC724E7D06F31ED93AC1B54083D9B9FCF09B135FDE9F4F6C1F0BA0142C3715E49015958C45315859DB12D942D75497FB51EDDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000659F22017ADF05031404CFDF060100DF070100DF0281F881CCF2D6E5CD28E4E12105B505AA161D9830DEFE2ABD8FFFA500839E345276CD3CCDF61B0FDE18AE48E1EA1A5CD7DA7A119BEFAE316C1F91D74BB77CD5C4E2EB91C3C356057D78561D1C661313D9540837CCDF9369C18E417E964C268B7FE60A387464C31A11358F303C18FB7C182BB3BD04148E0973A9FA8A128DA7B8F4E475C29A5CC5F2A289114FE7A3B34E1FECDABC8F8524A9C2230C778038B916106FF91EB77DBBF5AC973F3F2A3507590F5BF77CF94F39AF6F9D971B9207516A08F109B16DF1D1B4E673905EBC7B78561902B2C4C39CA864F4F422FAE9FE59CB112F82FFABBC9ACCB246EC46F0020BEDBF98EE768C206A0F13B5B3DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000659F220111DF05031404CFDF060100DF070100DF0281B0A2583AA40746E3A63C22478F576D1EFC5FB046135A6FC739E82B55035F71B09BEB566EDB9968DD649B94B6DEDC033899884E908C27BE1CD291E5436F762553297763DAA3B890D778C0F01E3344CECDFB3BA70D7E055B8C760D0179A403D6B55F2B3B083912B183ADB7927441BED3395A199EEFE0DEBD1F5FC3264033DA856F4A8B93916885BD42F9C1F456AAB8CFA83AC574833EB5E87BB9D4C006A4B5346BD9E17E139AB6552D9C58BC041195336485DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000659F220113DF05031404CFDF060100DF070100DF0281F8A3270868367E6E29349FC2743EE545AC53BD3029782488997650108524FD051E3B6EACA6A9A6C1441D28889A5F46413C8F62F3645AAEB30A1521EEF41FD4F3445BFA1AB29F9AC1A74D9A16B93293296CB09162B149BAC22F88AD8F322D684D6B49A12413FC1B6AC70EDEDB18EC1585519A89B50B3D03E14063C2CA58B7C2BA7FB22799A33BCDE6AFCBEB4A7D64911D08D18C47F9BD14A9FAD8805A15DE5A38945A97919B7AB88EFA11A88C0CD92C6EE7DC352AB0746ABF13585913C8A4E04464B77909C6BD94341A8976C4769EA6C0D30A60F4EE8FA19E767B170DF4FA80312DBA61DB645D5D1560873E2674E1F620083F30180BD96CA589DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000000659F220114DF05031404CFDF060100DF070100DF0281F8AEED55B9EE00E1ECEB045F61D2DA9A66AB637B43FB5CDBDB22A2FBB25BE061E937E38244EE5132F530144A3F268907D8FD648863F5A96FED7E42089E93457ADC0E1BC89C58A0DB72675FBC47FEE9FF33C16ADE6D341936B06B6A6F5EF6F66A4EDD981DF75DA8399C3053F430ECA342437C23AF423A211AC9F58EAF09B0F837DE9D86C7109DB1646561AA5AF0289AF5514AC64BC2D9D36A179BB8A7971E2BFA03A9E4B847FD3D63524D43A0E8003547B94A8A75E519DF3177D0A60BC0B4BAB1EA59A2CBB4D2D62354E926E9C7D3BE4181E81BA60F8285A896D17DA8C3242481B6C405769A39D547C74ED9FF95A70A796046B5EFF36682DC29DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000001529F22015CDF0503134DB4DF060100DF070100DF0281B0833F275FCF5CA4CB6F1BF880E54DCFEB721A316692CAFEB28B698CAECAFA2B2D2AD8517B1EFB59DDEFC39F9C3B33DDEE40E7A63C03E90A4DD261BC0F28B42EA6E7A1F307178E2D63FA1649155C3A5F926B4C7D7C258BCA98EF90C7F4117C205E8E32C45D10E3D494059D2F2933891B979CE4A831B301B0550CDAE9B67064B31D8B481B85A5B046BE8FFA7BDB58DC0D7032525297F26FF619AF7F15BCEC0C92BCDCBC4FB207D115AA65CD04C1CF982191DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220121DF05031343F0DF060100DF070100DF0281A0863B43586D710D2ECCF922644ACDD7015057A26BE7D6999A65D023DE94CD81A171E93C5BAB92C753767A4720C2ACFBF358387790CCD437806F9C1F19CF66FCF20BF42570FFE21ED742608F56C9CB0B4F277CF8EF3394C8BC595B314044197B7AAEAADBF1E44D763CDFE3DF368CBA6B09788F8EAEF9B47DEC02BEA131D58551430621D71AA5EEDE29FC1AC8CBE44CE92177E01EEBC080E94BEAD5FA0CAEF4B487DF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220123DF0503135025DF060100DF070100DF0281E0EEEACE9FD905E43DD1EC43F471570F9255379E43813267F0C6C0363977C607E8E169B834A5072977ADA9BDF4D0F50748F3D2DED1F863A9A510C4D67BC923EB53E77711BB079B32F2837F1381F141B27B9361E67DDB5AEF107F05231042A9D003DA49338476FBA2E8FFD8D48621C830A6BAB87751570BEAB77AA501846E8F9EDE25EAD306C45AA21CEEB506E5256AADB01AAA0A5C5773DB7A75DBFB5D1EA30C89BFCB4937C0B1B6EDADFF12F9808F1E9129A39AC6996C7D9E551BD1AF924320D965BC0726AD9F9CE430415F1FDF9AC37C3DC0454452D73F0E0B1CBC8214522F5FDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220118DF05031404CFDF060100DF070100DF0281B0A523924AFD826DAD39BC4532CB121C19A702D2B0D3F29CE79E2CBD0F847BC112A5FF61EF0E3913A6DF63A3E8017FC2B19F0E61304889A88E406DAC0FF82A423052E5387EF6C073D2B8C6004D2D4077C5179A78902CE4A8F361A85C6F46D56A75F374AF7AAD0F8409098AC1F388517184001AA316D05C842907BF0D62F8A05E083DBC8FED48FF84108D1C411C5540604408C42066E6B2ED465BC0DCBBB06383EE88C1CF0A7F694317C8B3A8EF1019059BDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220130DF0503134DB4DF060100DF070100DF0281F8B6D73BF68564C88A1AEE8BA70A5F60CE495CA722E097DADEEBB83B28040B1BAD16DBC9AC3CD181BA89193638E600AF397D220F0339A8E792AA08C1878482ACC463B3B3A257AE8667CDBC1D6613CB9CBB612830FDA7F7BA689A148EFFF34476F6E0A70C819C10B3B6150909B58BF9403F5BB2E9790EE82C50C8D6FB267C726DC255AE97FABF5A357B2A0FBD1387168D83B25ECD912027B3868F072E025240CF780CC8E5839823727E5547FD1366A203F4F70FA82660B8401D4D2D06FD9A4036D14C53F6289D6FDC724E7D06F31ED93AC1B54083D9B9FCF09B135FDE9F4F6C1F0BA0142C3715E49015958C45315859DB12D942D75497FB51EDDF040103DF03140000000000000000000000000000000000000000",
                "9F0605A0000002289F220188DF0503134DB4DF060100DF070100DF0281B0D6589C42073CD94C3C0008098DE209DA46AC0882AB5A0174AACA64A0E8BF2171098FF8A14470B2C0E76B792DBDA2D7AD27416E8D85190C151BF4DC19F51857A85387BA475D66682EAA954139BD1E7E37CF5F35F37DAAEC25B64722E9D68EDC266B4689F05F74D30370CC7C9F2A4B103B9FCDCD524519E9D80AF49E370116CB2287ABF001B5BCC9A34526EBAFD2E88DB752DFE24FE3DF1AFF71733D457B7899E7EB07DC8812DED19CA06D5BE14EC6A9D5DF040103DF03140000000000000000000000000000000000000000"
            )
            for (capkHexString in capkList) {
                try {
                    val capk = hexStr2Rid(capkHexString) // Parse hex string
                    emvOptV2.addCapk(capk) // Náº¡p CAPK [cite: 552]
                } catch (e: Exception) {
                    Timber.e(e, "   Lá»—i khi parse/náº¡p CAPK: ${capkHexString.take(50)}...")
                }
            }
            Timber.d("   Náº¡p CAPKs máº·c Ä‘á»‹nh tá»« tÃ i liá»‡u thÃ nh cÃ´ng!")
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
    fun setTerminalParam(emv: EMVOptV2, terminal: Terminal) {
        try {
            val termParam = EmvTermParamV2().apply {
                // ðŸ”¥ COPY Y CHANG Tá»ª LOG THÃ€NH CÃ”NG
                capability = "E0F8C8"           // Há»— trá»£ Enciphered PIN online
                addCapability = "0300C00000"     // âš ï¸ KhÃ¡c vá»›i code cÅ©!
                terminalType = "22"
                countryCode = "0704"
                currencyCode = "0704"
                currencyExp = "02"

                // ðŸ”¥ KEY SETTINGS
                bypassPin = true        // Bypass offline PIN verification
                getDataPIN = true       // Cho phÃ©p láº¥y PIN data Ä‘á»ƒ encrypt online

                IsReadLogInCard = false
                TTQ = "26000080"
                accountType = "00"
                adviceFlag = true
                batchCapture = false
                bypassAllFlg = false
                ectSiFlg = true
                ectSiVal = true
                ectTlFlg = true
                ectTlVal = "100000"
                ifDsn = "3030303030393035"
                isSupportAccountSelect = true
                isSupportExceptFile = true
                isSupportMultiLang = true
                isSupportSM = true
                isSupportTransLog = true
                scriptMode = false
                surportPSESel = true
                termAIP = true
                useTermAIPFlg = true
            }
            emv.setTerminalParam(termParam)

        } catch (_: Exception) {
        }
    }
    fun setEmvTlvs(context: Context, emv: EMVOptV2, terminal: Terminal?) {
        val evmConfigs = terminal?.evmConfigs
        setGlobalTlvs(emv, terminal)

        // ðŸ”¥ Má»šI: Load CVM config tá»« JSON
        val cvmConfig = ResourceHelper.loadCvmFromAssets(context)
        evmConfigs?.forEach { config ->
            when (config.vendorName.uppercase(Locale.getDefault())) {
                "JCB" -> setJcbTlvs(emv, config, cvmConfig)
                "NAPAS" -> setNapasTlvs(emv, config, cvmConfig)
                "VISA" -> setPayWaveTlvs(emv, config, cvmConfig)
                "MASTERCARD" -> setPayPassTlvs(emv, config, cvmConfig)
                "UNIONPAY", "UNION PAY" -> setQpbocTlvs(emv, config, cvmConfig)
                "AMEX", "AMERICAN EXPRESS" -> setExpressPayTlvs(emv, config, cvmConfig)
            }
        }
    }
    fun injectKeys(securityOpt: SecurityOptV2, terminal: Terminal): Boolean {
        return try {
            // ksn
            val ksn = terminal.ksn ?: "FFFF4357480393800000"
            val ksnBytes = UtilHelper.hexStringToByteArray(ksn)

            // bdk
            val bdk = terminal.bdk ?: "C1D0F8FB4958670DBA40AB1F3752EF0D"
            val bdkBytes = UtilHelper.hexStringToByteArray(bdk)

            val keyType = 7
            val keyIndex = 1
            val result = securityOpt.saveKeyDukpt(
                keyType,
                bdkBytes,
                null,
                ksnBytes,
                1,              // algorithmType DES
                keyIndex
            )
            result == 0
        } catch (e: Exception) {
            false
        }
    }

    private fun setGlobalTlvs(emv: EMVOptV2, terminal: Terminal?) {
        val config: EvmConfig = terminal?.evmConfigs?.firstOrNull() ?: EvmConfig()

        val globalTags = arrayOf(
            "9F1A", "5F2A", "5F36", "9F33", "9F35", "9F40",
            "9F66", "9F09", "9F1C", "9F15", "9F16", "9F1E"
        )

        val ttq = when (config.vendorName.uppercase(Locale.getDefault())) {
            "VISA" -> "26000080"
            "MASTERCARD" -> "3600C080"
            "NAPAS" -> "26000000"  // NAPAS Pure TTQ - CRITICAL for L2 candidate list building
            else -> "3600C080"
        }
        val globalValues = arrayOf(
            config.countryCode9F1A,
            config.transCurrencyCode5F2A,
            config.transCurrencyExp,
            config.terminalCap9F33,
            config.terminalType9F35,
            config.exTerminalCap9F40,
            ttq,
            config.version9F09,
            terminal?.tid ?: config.terminalId9F1C,
            config.mcc9F15,
            terminal?.mid ?: config.merchantId9F16,
            "00000001"
        )

        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, globalTags, globalValues)
    }
    private fun setJcbTlvs(emv: EMVOptV2, config: EvmConfig, cvmConfig: CvmConfig?) {
        val tags = arrayOf(
            "DF8117", "DF8118", "DF8119", "DF811F", "DF811E", "DF812C",
            "DF8123", "DF8124", "DF8125", "DF8126"
        )

        val chipCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "jcb", "chip")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val contactlessCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "jcb", "contactless")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val floorLimit = config.floorLimit9F1B.ifEmpty { "000000500000" }

        val chipValues = arrayOf(
            floorLimit,
            floorLimit,
            floorLimit,
            "E8",
            "00",
            floorLimit,
            config.tacDefault,
            config.tacDenial,
            config.tacOnline,
            chipCvm.cvmRequiredLimit
        )

        val contactlessValues = arrayOf(
            floorLimit,
            floorLimit,
            floorLimit,
            contactlessCvm.contactlessTransLimit,
            contactlessCvm.cvmRequiredLimit,
            contactlessCvm.readerCvmRequiredLimit,
            config.tacDefault,
            config.tacDenial,
            config.tacOnline,
            contactlessCvm.cvmRequiredLimit
        )

        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, tags, chipValues)
        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_JCB, tags, contactlessValues)
    }
    private fun setQpbocTlvs(emv: EMVOptV2, config: EvmConfig, cvmConfig: CvmConfig?) {
        val chipValues = arrayOf("E0", "F8", "F8", "E8", "00")
        val tags = arrayOf("DF69", "DF70", "DF71", "DF72", "DF73")
        val contactlessValues = arrayOf("E0", "F8", "F8", "E8", "00")
        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, tags, chipValues)
        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, tags, contactlessValues)
    }
    private fun setNapasTlvs(emv: EMVOptV2, config: EvmConfig, cvmConfig: CvmConfig?) {
        val tags = arrayOf(
            "DF7F",   // AID - Application Identifier
            "DF8134", // NAPAS-specific tag
            "DF8133", // NAPAS-specific tag (mCTLSAppCapa)
            "9F66",   // TTQ - Terminal Transaction Qualifiers
            "DF8117", // cardDataInputCap
            "DF8118", // chipCVMCap
            "DF8119", // chipCVMCapNoCVM
            "DF811A", // UDOL - User Data Object List
            "DF811B", // kernelConfig
            "DF811D", // Status check
            "DF811E", // MSDCVMCap
            "DF811F", // securityCap
            "DF8120", // ClTACDefault
            "DF8121", // CLTACDenial
            "DF8122", // CLTACOnline
            "DF8123", // TAC Default
            "DF8124", // CLTransLimitNoCDCVM
            "DF8125", // CLTransLimitCDCVM
            "DF812C"  // MSDCVMCapNoCVM
        )

        val chipCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "napas", "chip")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val contactlessCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "napas", "contactless")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val chipValues = arrayOf(
            config.aid9F06.ifEmpty { "A0000007271010" },  // DF7F
            "D9",                                          // DF8134
            "3200E043F9",                                  // DF8133
            "26000080",                                    // 9F66
            "E0",                                          // DF8117
            "08",                                          // DF8118
            "F0",                                          // DF8119
            "9F6A04",                                      // DF811A
            "30",                                          // DF811B
            "02",                                          // DF811D
            chipCvm.cvmRequiredLimit,                      // DF811E
            "08",                                          // DF811F
            config.tacDefault,                             // DF8120
            config.tacDenial,                              // DF8121
            config.tacOnline,                              // DF8122
            config.tacDefault,                             // DF8123
            chipCvm.contactlessTransLimit,                 // DF8124
            chipCvm.contactlessCvmLimit,                   // DF8125
            chipCvm.readerCvmRequiredLimit                 // DF812C
        )

        val contactlessValues = arrayOf(
            config.aid9F06.ifEmpty { "A0000007271010" },  // DF7F
            "D9",                                          // DF8134
            "3200E043F9",                                  // DF8133
            "26000080",                                    // 9F66
            "E0",                                          // DF8117
            "08",                                          // DF8118
            "F0",                                          // DF8119
            "9F6A04",                                      // DF811A
            "30",                                          // DF811B
            "02",                                          // DF811D
            contactlessCvm.cvmRequiredLimit,               // DF811E
            "08",                                          // DF811F
            "A4D0048000",                                  // DF8120
            "0000000000",                                  // DF8121
            "A4D0048000",                                  // DF8122
            config.tacDefault,                             // DF8123
            contactlessCvm.contactlessTransLimit,          // DF8124
            contactlessCvm.contactlessCvmLimit,            // DF8125
            "08"                                           // DF812C
        )

        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, tags, chipValues)
        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_PURE, tags, contactlessValues)
    }
    private fun setPayWaveTlvs(emv: EMVOptV2, config: EvmConfig, cvmConfig: CvmConfig?) {
        val tags = arrayOf(
            "DF8117", "DF8118", "DF8119", "DF811B", "DF811D", "DF811E",
            "DF811F", "DF8120", "DF8121", "DF8122", "DF8123", "DF8124",
            "DF8125", "DF812C"
        )

        val chipCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "visa", "chip")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val contactlessCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "visa", "contactless")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val floorLimit = config.floorLimit9F1B.ifEmpty { "000005000000" }
        val chipValues = arrayOf(
            floorLimit,
            "000000000000",
            "000000999999",
            "30",
            "02",
            chipCvm.cvmRequiredLimit,
            chipCvm.contactlessTransLimit,
            "000000999999",
            chipCvm.contactlessCvmLimit,
            "0000000000",
            config.tacDefault,
            config.tacDenial,
            config.tacOnline,
            chipCvm.readerCvmRequiredLimit
        )

        val contactlessValues = arrayOf(
            floorLimit,
            "000000000000",
            "000000999999",
            "30",
            "02",
            contactlessCvm.cvmRequiredLimit,
            contactlessCvm.contactlessTransLimit,
            "000000999999",
            contactlessCvm.contactlessCvmLimit,
            "0000000000",
            config.tacDefault,
            config.tacDenial,
            config.tacOnline,
            contactlessCvm.readerCvmRequiredLimit
        )

        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, tags, chipValues)
        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_PAYWAVE, tags, contactlessValues)
    }
    private fun setPayPassTlvs(emv: EMVOptV2, config: EvmConfig, cvmConfig: CvmConfig?) {
        val tags = arrayOf(
            "DF8117", "DF8118", "DF8119", "DF811F", "DF811E", "DF812C",
            "DF8123", "DF8124", "DF8125", "DF8126", "DF811B", "DF811D",
            "DF8122", "DF8120", "DF8121"
        )

        val chipCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "master", "chip")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val contactlessCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "master", "contactless")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val floorLimit = config.floorLimit9F1B.ifEmpty { "000000500000" }

        val chipValues = arrayOf(
            floorLimit,
            floorLimit,
            floorLimit,
            "E8",
            "00",
            chipCvm.readerCvmRequiredLimit,
            config.tacDefault,
            config.tacDenial,
            config.tacOnline,
            chipCvm.cvmRequiredLimit,
            "30",
            "02",
            "0000000000",
            "000000000000",
            "000000000000"
        )

        val contactlessValues = arrayOf(
            floorLimit,
            floorLimit,
            floorLimit,
            contactlessCvm.contactlessTransLimit,
            contactlessCvm.cvmRequiredLimit,
            contactlessCvm.readerCvmRequiredLimit,
            config.tacDefault,
            config.tacDenial,
            config.tacOnline,
            contactlessCvm.cvmRequiredLimit,
            "30",
            "02",
            "0000000000",
            "000000000000",
            contactlessCvm.contactlessCvmLimit
        )

        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, tags, chipValues)
        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_PAYPASS, tags, contactlessValues)
    }
    private fun setExpressPayTlvs(emv: EMVOptV2, config: EvmConfig, cvmConfig: CvmConfig?) {
        val tags = arrayOf(
            "DF8117", "DF8118", "DF8119", "DF811F", "DF811E", "DF812C",
            "DF8123", "DF8124", "DF8125"
        )

        val chipCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "amex", "chip")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val contactlessCvm = if (cvmConfig != null) {
            ResourceHelper.convertToTlv(cvmConfig, "amex", "contactless")
        } else {
            ResourceHelper.getDefaultTlvValues()
        }

        val chipValues = arrayOf(
            "E0",
            "F8",
            "F8",
            "E8",
            chipCvm.cvmRequiredLimit,
            chipCvm.readerCvmRequiredLimit,
            config.tacDefault,
            config.tacDenial,
            config.tacOnline
        )

        val contactlessValues = arrayOf(
            "E0",
            "F8",
            "F8",
            contactlessCvm.contactlessTransLimit,
            contactlessCvm.cvmRequiredLimit,
            contactlessCvm.readerCvmRequiredLimit,
            config.tacDefault,
            config.tacDenial,
            config.tacOnline
        )

        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_NORMAL, tags, chipValues)
        emv.setTlvList(AidlConstants.EMV.TLVOpCode.OP_AE, tags, contactlessValues)
    }

    private fun char2Byte(c: Char): Int {
        if (c >= 'a') {
            return (c.code - 'a'.code + 10) and 0x0f
        }
        if (c >= 'A') {
            return (c.code - 'A'.code + 10) and 0x0f
        }
        return (c.code - '0'.code) and 0x0f
    }
    private fun hexStr2Byte(hexStr: String): Byte {
        return hexStr.toInt(16).toByte()
    }
    private  fun hexStr2Aid(hexStr: String?): AidV2 {
        val aidV2 = AidV2()
        val map = TLVUtil.buildTLVMap(hexStr)
        var tlv = map["DF21"]
        if (tlv != null) {
            aidV2.cvmLmt = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF20"]
        if (tlv != null) {
            aidV2.termClssLmt = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF19"]
        if (tlv != null) {
            aidV2.termClssOfflineFloorLmt = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F7B"]
        if (tlv != null) {
            aidV2.termOfflineFloorLmt = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F06"]
        if (tlv != null) {
            aidV2.aid = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF01"]
        if (tlv != null) {
            aidV2.selFlag = hexStr2Byte(tlv.value)
        }
        tlv = map["DF17"]
        if (tlv != null) {
            aidV2.targetPer = hexStr2Byte(tlv.value)
        }
        tlv = map["DF16"]
        if (tlv != null) {
            aidV2.maxTargetPer = hexStr2Byte(tlv.value)
        }
        tlv = map["9F1B"]
        if (tlv != null) {
            aidV2.floorLimit = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF15"]
        if (tlv != null) {
            aidV2.threshold = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF13"]
        if (tlv != null) {
            aidV2.TACDenial = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF12"]
        if (tlv != null) {
            aidV2.TACOnline = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF11"]
        if (tlv != null) {
            aidV2.TACDefault = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F01"]
        if (tlv != null) {
            aidV2.AcquierId = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF14"]
        if (tlv != null) {
            aidV2.dDOL = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F09"]
        if (tlv != null) {
            aidV2.version = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F4E"]
        if (tlv != null) {
            aidV2.merchName = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F15"]
        if (tlv != null) {
            aidV2.merchCateCode = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F16"]
        if (tlv != null) {
            aidV2.merchId = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F3C"]
        if (tlv != null) {
            aidV2.referCurrCode = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F3D"]
        if (tlv != null) {
            aidV2.referCurrExp = hexStr2Byte(tlv.value)
        }
        tlv = map["DFC108"]
        if (tlv != null) {
            aidV2.clsStatusCheck = hexStr2Byte(tlv.value)
        }
        tlv = map["DFC109"]
        if (tlv != null) {
            aidV2.zeroCheck = hexStr2Byte(tlv.value)
        }
        tlv = map["DFC10A"]
        if (tlv != null) {
            aidV2.kernelType = hexStr2Byte(tlv.value)
        }
        tlv = map["DFC10B"]
        if (tlv != null) {
            aidV2.paramType = hexStr2Byte(tlv.value)
        }
        tlv = map["9F66"]
        if (tlv != null) {
            aidV2.ttq = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F1C"]
        if (tlv != null) {
            aidV2.termId = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F1D"]
        if (tlv != null) {
            aidV2.riskManData = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF8101"]
        if (tlv != null) {
            aidV2.referCurrCon = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF8102"]
        if (tlv != null) {
            aidV2.tDOL = hexStr2Bytes(tlv.value)
        }
        tlv = map["DFC10C"]
        if (tlv != null) {
            aidV2.kernelID = hexStr2Bytes(tlv.value)
        }
        return aidV2
    }
    private fun hexStr2Rid(hexStr: String?): CapkV2 {
        val capkV2 = CapkV2()
        val map = TLVUtil.buildTLVMap(hexStr)
        var tlv = map["9F06"]
        if (tlv != null) {
            capkV2.rid = hexStr2Bytes(tlv.value)
        }
        tlv = map["9F22"]
        if (tlv != null) {
            capkV2.index = hexStr2Byte(tlv.value)
        }
        tlv = map["DF06"]
        if (tlv != null) {
            capkV2.hashInd = hexStr2Byte(tlv.value)
        }
        tlv = map["DF07"]
        if (tlv != null) {
            capkV2.arithInd = hexStr2Byte(tlv.value)
        }
        tlv = map["DF02"]
        if (tlv != null) {
            capkV2.modul = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF04"]
        if (tlv != null) {
            capkV2.exponent = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF05"]
        if (tlv != null) {
            capkV2.expDate = hexStr2Bytes(tlv.value)
        }
        tlv = map["DF03"]
        if (tlv != null) {
            capkV2.checkSum = hexStr2Bytes(tlv.value)
        }
        return capkV2
    }
    private fun hexStr2Bytes(hexStr: String?): ByteArray {
        if (TextUtils.isEmpty(hexStr)) {
            return ByteArray(0)
        }
        val length = hexStr!!.length / 2
        val chars = hexStr.toCharArray()
        val b = ByteArray(length)
        for (i in 0..<length) {
            b[i] = (char2Byte(chars[i * 2]) shl 4 or char2Byte(chars[i * 2 + 1])).toByte()
        }
        return b
    }
    private fun injectAidsFromJson(context: Context, emvOptV2: EMVOptV2): Int {
        try {
            val aidList = ResourceHelper.loadAidsFromAssets(context) ?: run {
                return 0
            }

            var successCount = 0
            for ((index, aidData) in aidList.withIndex()) {
                val entry = aidData.getEntry() ?: continue
                val (type, aidEntry) = entry

                try {
                    val aidV2 = ResourceHelper.convertToAidV2(aidEntry, type)
                    val result = emvOptV2.addAid(aidV2)
                    if (result == 0) {
                        successCount++
                    }
                } catch (_: Exception) {
                }
            }
            return successCount
        } catch (e: Exception) {
            return 0
        }
    }
    private fun injectCapksFromJson(context: Context, emvOptV2: EMVOptV2): Int {
        try {
            val capkList = ResourceHelper.loadCapksFromAssets(context) ?: run {
                return 0
            }

            var successCount = 0
            for (capkData in capkList) {
                try {
                    val capkV2 = ResourceHelper.convertToCapkV2(capkData)
                    val result = emvOptV2.addCapk(capkV2)

                    if (result == 0) {
                        successCount++
                    }
                } catch (_: Exception) {
                }
            }
            return successCount

        } catch (e: Exception) {
            return 0
        }
    }

    fun removePaddingCard(card: Card): Card {
        val pan = card.clearPan
        val track2 = card.track2
        if (pan.endsWith("F", ignoreCase = true)) {
            card.clearPan = pan.dropLast(1)
            if (card.emvData != null)
                card.emvData = card.emvData!!.replace(pan, card.clearPan)
        }
        if (track2 != null && track2.endsWith("F", ignoreCase = true)) {
            card.track2 = track2.dropLast(1)
            if (card.emvData != null)
                card.emvData = card.emvData!!.replace(track2, card.track2.toString())
        }
        return card
    }
}
